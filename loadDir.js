// Generated by CoffeeScript 1.3.3
(function() {
  var CoffeeScript, extension, fs, loadDir, _, _to_filename;

  _ = require('underscore');

  fs = require('fs');

  CoffeeScript = require('coffee-script');

  extension = require('./string_helper').extension;

  _to_filename = function(fileName, extension) {
    return [filename, extension].join('.');
  };

  module.exports = loadDir = function(options) {
    var args, as_object, binary, black_list, callback, compile, destination, filenamesOnly, freshen, on_change, path, priority, recursive, relativePath, reprocess, requireFiles, to_filename, white_list, _ref, _ref1, _xp;
    if (options == null) {
      options = {};
    }
    white_list = options.white_list, black_list = options.black_list, destination = options.destination, compile = options.compile, to_filename = options.to_filename, relativePath = options.relativePath, callback = options.callback, filenamesOnly = options.filenamesOnly, priority = options.priority, freshen = options.freshen, reprocess = options.reprocess, binary = options.binary;
    as_object = (_ref = options.as_object) != null ? _ref : false;
    recursive = (_ref1 = options.recursive) != null ? _ref1 : true;
    path = options.path;
    on_change = options.on_change;
    destination = options.destination;
    compile = options.compile;
    callback = options.destination;
    to_filename = options.to_filename || _to_filename;
    requireFiles = options.require || false;
    args = arguments[0];
    if (recursive == null) {
      recursive = true;
    }
    if (relativePath == null) {
      relativePath = '';
    }
    _xp = {};
    if ('/' === _.last(path)) {
      path = path.slice(0, -1);
    }
    _.map(fs.readdirSync(path), function(fileName) {
      var addToObject, compiled, deepContents, fullPath, image_formats, process, readFile, recompile, trimmedFN, _changedFileName, _ref2, _writeDir,
        _this = this;
      if (white_list) {
        console.log({
          fileName: fileName
        });
        console.log(color('ASDF', 'red'));
      }
      if ((black_list != null) && _.include(black_list, fileName)) {
        return;
      }
      if ((white_list != null) && !_.include(white_list, fileName)) {
        return;
      }
      if (fileName.charAt(0) === '.') {
        return;
      }
      trimmedFN = fileName.trim_ext();
      fullPath = "" + path + "/" + fileName;
      if (fs.lstatSync(fullPath).isDirectory()) {
        if (recursive) {
          deepContents = loadDir(_.extend(_.clone(args), {
            path: fullPath,
            relativePath: (relativePath != null ? relativePath : '') + fileName + '/'
          }));
          if (as_object) {
            _xp[trimmedFN] = _.extend((_ref2 = _xp[trimmedFN]) != null ? _ref2 : {}, deepContents);
          } else {
            _xp = _.extend(deepContents, _xp);
          }
        }
        return;
      }
      if (on_change || freshen || reprocess) {
        _.defer(function() {
          return fs.watch(fullPath, function() {
            return _.delay(function() {
              if (on_change === 'restart') {
                loadDir.restartServer();
              }
              console.log('recompilin');
              if (reprocess) {
                console.log('refreshen');
                if (typeof readFile === "function") {
                  readFile();
                }
                if (typeof process === "function") {
                  process(true);
                }
              }
              if (freshen) {
                console.log('refreshen');
                if (typeof readFile === "function") {
                  readFile();
                }
                if (typeof recompile === "function") {
                  recompile();
                }
                return typeof addToObject === "function" ? addToObject() : void 0;
              }
            }, 250);
          });
        });
      }
      console.log('loadDir 120', fullPath, fileName);
      compiled = '';
      if (filenamesOnly) {
        return _xp[trimmedFN] = {};
      }
      image_formats = ['png', 'jpg', 'gif', 'jpeg'];
      if (binary == null) {
        binary = (_(image_formats)).include(extension(fullPath).toLowerCase()) ? 'binary' : void 0;
      }
      (readFile = function() {
        var contents, _ref3;
        contents = fs.readFileSync(fullPath, binary).toString();
        return compiled = (_ref3 = typeof compile === "function" ? compile(contents) : void 0) != null ? _ref3 : contents;
      })();
      if (_.isFunction(callback)) {
        (process = function(reloaded) {
          return compiled = callback(_.extend(_.clone(args), {
            compiled: compiled,
            relativePath: relativePath,
            fileName: fileName,
            fullPath: fullPath,
            reloaded: reloaded
          }));
        })(false);
      }
      if (requireFiles) {
        try {
          require(fullPath);
        } catch (er) {
          _.defer(function() {
            return require(fullPath);
          });
        }
      }
      _writeDir = destination + '/' + (relativePath != null ? relativePath : '');
      _changedFileName = _writeDir + to_filename(trimmedFN, extension);
      if (destination != null) {
        try {
          fs.lstatSync(_writeDir);
        } catch (er) {
          fs.mkdirSync(_writeDir);
        }
        (recompile = function() {
          return fs.writeFileSync(_changedFileName, compiled, binary);
        })();
      }
      return (addToObject = function() {
        if (as_object != null) {
          return _xp[(relativePath != null ? relativePath : '') + fileName] = compiled;
        } else {
          return _xp[trimmedFN] = _.extend(compiled, _xp[trimmedFN]);
        }
      })();
    });
    return _xp;
  };

  loadDir.restartServer = function() {
    fs.writeFileSync('loadDir_tmp_restart.txt', Math.random());
    require('loadDir_tmp_restart.txt');
    return fs.writeFileSync('loadDir_tmp_restart.txt', Math.random());
  };

}).call(this);
